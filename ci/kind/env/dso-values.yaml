global:
  env:
    NODE_ENV: "production"
  keycloak:
    domain: keycloak.dso.local
    realm: cloud-pi-native
    protocol: http
    clientIds:
      frontend: dso-console-frontend
      backend: console-backend
    clientSecretBackend: client-secret-backend
    redirectUri: http://console.dso.local
    sessionSecrets:
      backend: a-very-strong-secret-with-more-than-32-char

config:
  create: true
  projectsRootDir: forge-mi/projects
  secrets:
    ARGOCD_URL: "https://argo-cd.readthedocs.io"
    GITLAB_URL: "https://gitlab.com"
    HARBOR_URL: "https://goharbor.io"
    KEYCLOAK_URL: "https://www.keycloak.org"
    NEXUS_URL: "https://sonatype.com/products/nexus-repository"
    SONARQUBE_URL: "https://www.sonarqube.org"
    VAULT_URL: "https://www.vaultproject.io"

ingress:
  enabled: true
  className: "traefik"
  hosts:
    - "console.dso.local"
  tls: []

server:
  image:
    repository: dso-console/server
    tag: prod
    pullPolicy: Never
  initContainers:
    - name: wait-for-keycloak
      image: docker.io/wbitt/network-multitool:alpine-minimal
      command:
        - "/bin/sh"
        - "-c"
      args:
        - "while [ $(curl -sw '%{http_code}' http://$KEYCLOAK_DOMAIN -o /dev/null) -ne 200 ]; do sleep 3; echo 'Waiting for keycloak...'; done"
      env:
        - name: KEYCLOAK_DOMAIN
          value: dso-cpn-keycloak
  dbDataCm: db-data-cm
  env:
    CI: "true"
    DEV_SETUP: "true"
    KEYCLOAK_DOMAIN: dso-cpn-keycloak

client:
  image:
    repository: dso-console/client
    tag: prod
    pullPolicy: Never
  env:
    CI: "true"

postgresql:
  enabled: true
  architecture: "standalone"
  auth:
    postgresPassword: "admin"
    username: "admin"
    password: "admin"
    database: "dso-console-db"
  primary:
    persistence:
      size: "1Gi"

keycloak:
  enabled: true
  auth:
    adminUser: "admin"
    adminPassword: "admin"
  ingress:
    enabled: true
    hostname: "keycloak.dso.local"
    tls: false
  production: false
  tls:
    enabled: false
    autoGenerated: false
  command:
    - /opt/bitnami/keycloak/bin/kc.sh
  args:
    - start-dev
    - --import-realm
  extraVolumes:
    - name: realm-dev
      configMap:
        name: keycloak-realm
    - name: extensions
      emptyDir: {}
  extraVolumeMounts:
    - mountPath: /opt/bitnami/keycloak/data/import/realm-dev.json
      subPath: realm-dev.json
      name: realm-dev
    - mountPath: /opt/bitnami/keycloak/providers
      name: extensions
  postgresql:
    enabled: true
    architecture: "standalone"
    auth:
      postgresPassword: "admin"
      username: "admin"
      password: "admin"
      database: "keycloak"
    primary:
      persistence:
        size: "1Gi"
  extraEnvVars:
    - name: DSFR_THEME_HOME_URL
      value: http://console.dso.local
    - name: DSFR_THEME_SERVICE_TITLE
      value: Cloud π Native
    - name: DSFR_THEME_BRAND_TOP
      value: "Ministère<br/>de l'intérieur<br/>et des outre-mer"
    - name: DSFR_THEME_TOS_URL
      value: http://console.dso.local/cgu
    - name: DSFR_THEME_CONTACT_EMAIL
      value: cloudpinative-relations@interieur.gouv.fr
    - name: JAVA_OPTS
      value: >-
        -Dkeycloak.profile=preview
  initContainers:
    - name: realm-ext-provider
      image: docker.io/curlimages/curl:8.8.0
      imagePullPolicy: IfNotPresent
      command:
        - sh
      args:
        - -c
        - curl -LfS -o /extensions/keycloak-theme-dsfr.jar https://github.com/codegouvfr/keycloak-theme-dsfr/releases/download/v1.0.3/retrocompat-keycloak-theme.jar
      volumeMounts:
        - name: extensions
          mountPath: /extensions
