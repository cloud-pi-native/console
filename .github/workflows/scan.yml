name: Scan application

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
    branches:
      # - main
      - "**"
  workflow_dispatch:

jobs:
  build-matrix:
    name: Init build (Create matrix)
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.build-matrix.outputs.images }}
    steps:
      - name: Checks-out repository
        uses: actions/checkout@v3
      - name: Generate matrix for build
        id: build-matrix
        run: |
          echo "images=$(./ci/scripts/build-matrix.sh -f ./docker/docker-compose.prod.yml -c)" >> $GITHUB_OUTPUT

  build:
    name: Build application
    runs-on: ubuntu-latest
    needs:
      - build-matrix
    strategy:
      matrix:
        images: ${{ fromJSON(needs.build-matrix.outputs.images) }}
    steps:
      - name: Checks-out repository
        uses: actions/checkout@v3
      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v2
      # - name: Set up QEMU (for multi platform build)
      #   uses: docker/setup-qemu-action@v2
      - name: Build and push docker images
        if: ${{ matrix.images.build != false }}
        uses: docker/build-push-action@v3
        with:
          context: ${{ matrix.images.build.context }}
          file: ${{ matrix.images.build.dockerfile }}
          tags: ${{ matrix.images.image }}
          target: ${{ matrix.images.build.target }}
          # platforms: ${{ matrix.images.build.platforms }}
          # push: true
          outputs: type=docker,dest=/tmp/${{ matrix.images.name }}.tar
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.images.name }}
          path: /tmp/${{ matrix.images.name }}.tar
          retention-days: 1

  images-scan:
    name: Scan images vulnerabilities
    runs-on: ubuntu-latest
    needs:
      - build
    strategy:
      matrix:
        images: ${{ fromJSON(needs.build-matrix.outputs.images) }}
    steps:
      - name: Set up Docker buildx
        if: ${{ matrix.images.build != false }}
        uses: docker/setup-buildx-action@v2
      - name: Download artifact
        if: ${{ matrix.images.build != false }}
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.images.name }}
          path: /tmp
      - name: Load Docker image
        if: ${{ matrix.images.build != false }}
        run: |
          docker load --input /tmp/${{ matrix.images.name }}.tar
          docker image ls -a
      - name: Create security artifacts directory
        run: mkdir -p /tmp/vulnerability-report/images/
      - name: Run Trivy vulnerability scanner on images
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "${{ matrix.images.image }}"
          format: "json"
          exit-code: "1"
          vuln-type: "os,library"
          security-checks: "vuln,secret,config"
          ignore-unfixed: true
          output: "/tmp/vulnerability-report/images/${{ matrix.images.name }}.json"
        continue-on-error: true
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v3
        with:
          name: vulnerability-report
          path: /tmp/vulnerability-report/
          retention-days: 14

  config-scan:
    name: Scan config files vulnerabilities
    runs-on: ubuntu-latest
    needs:
      - build-matrix
    steps:
      - name: Checks-out repository
        uses: actions/checkout@v3
      - name: Create security artifacts directory
        run: mkdir -p /tmp/vulnerability-report/configs/
      - name: Run Trivy vulnerability scanner on config files
        uses: aquasecurity/trivy-action@master
        with:
          scan-ref: "."
          scan-type: "config"
          format: "json"
          exit-code: "1"
          ignore-unfixed: true
          output: "/tmp/vulnerability-report/configs/config.json"
        continue-on-error: true
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v3
        with:
          name: vulnerability-report
          path: /tmp/vulnerability-report/
          retention-days: 14

  vulnerability-report:
    name: Build vulnerability report
    runs-on: ubuntu-latest
    needs:
      - images-scan
      - config-scan
    steps:
      - name: Checks-out repository
        uses: actions/checkout@v3
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: vulnerability-report
          path: /tmp/vulnerability-report
      - name: Build vulnerability report
        run: |
          sh ci/scripts/vuln-report.sh \
            -i "/tmp/vulnerability-report" \
            -o "/tmp/vulnerability-issue.md" \
            -p "${{ github.repository }}" \
            -r "${{ github.run_id }}"
          echo "REPORT_BODY=$(cat /tmp/vulnerability-issue.md)" >> $GITHUB_ENV
      - name: Create security report issue
        uses: imjohnbo/issue-bot@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          labels: "security"
          title: "Vulnerability scan report"
          pinned: false
          close-previous: true
          body: ${{ env.REPORT_BODY }}
